<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer Angry Birds</title>
    <meta name="viewport" content="width=800">
    <style>
        body { 
            background: linear-gradient(to bottom, #87CEEB, #98FB98); 
            color: #333; 
            text-align: center; 
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        #gameCanvas { 
            background: linear-gradient(to bottom, #87CEEB, #98FB98); 
            margin-top: 1em; 
            border-radius: 10px;
            border: 3px solid #654321;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .info { 
            margin-top: 16px; 
            font-family: sans-serif; 
            color: #333;
            font-weight: bold;
        }
        .game-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .player-score {
            background: rgba(255,255,255,0.8);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #654321;
        }
    </style>
    <script>
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@multisynq/client@latest/bundled/multisynq-client.min.js';
            script.onload = function() {
                if (document.readyState === "loading") {
                    document.addEventListener('DOMContentLoaded', startAngryBirdsGame);
                } else {
                    startAngryBirdsGame();
                }
            };
            document.head.appendChild(script);
        })();
    
        function startAngryBirdsGame() {
            const API_KEY = "2PQ0Ect1pnEU6z0SzI3hzkrLeAJCiSVnv6CAxZoRJ7";
            const APP_ID = "com.multiplayer.demo";
            const ROOM_ID = "demo-room";
            const PASSWORD = "multisynqdeneme";
            
            // Game constants
            const GRAVITY = 0.5;
            const GROUND_Y = 380;
            const SLINGSHOT_X = 100;
            const SLINGSHOT_Y = 300;
            const BIRD_RADIUS = 15;
            const PIG_RADIUS = 20;
            const BLOCK_SIZE = 30;
            
            let myColor = getRandomColor();
            let myId = null;
            let state = { 
                players: {},
                birds: [],
                pigs: [],
                blocks: [],
                scores: {},
                currentTurn: null,
                gameStarted: false
            };
            window.state = state;
            
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // Game state
            let isDragging = false;
            let dragStart = { x: 0, y: 0 };
            let currentBird = null;
            let myTurn = false;

            function getRandomColor() {
                const colors = ['#e74c3c', '#3498db', '#27ae60', '#f1c40f', '#9b59b6', '#e67e22'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            // Bird class
            class Bird {
                constructor(x, y, playerId) {
                    this.x = x;
                    this.y = y;
                    this.vx = 0;
                    this.vy = 0;
                    this.playerId = playerId;
                    this.active = true;
                    this.launched = false;
                }
                
                update() {
                    if (!this.launched) return;
                    
                    this.x += this.vx;
                    this.y += this.vy;
                    this.vy += GRAVITY;
                    
                    // Ground collision
                    if (this.y + BIRD_RADIUS > GROUND_Y) {
                        this.y = GROUND_Y - BIRD_RADIUS;
                        this.vy = -this.vy * 0.6;
                        this.vx *= 0.8;
                        
                        if (Math.abs(this.vy) < 2) {
                            this.active = false;
                        }
                    }
                    
                    // Wall collision
                    if (this.x - BIRD_RADIUS < 0 || this.x + BIRD_RADIUS > canvas.width) {
                        this.vx = -this.vx * 0.8;
                    }
                }
                
                draw() {
                    if (!this.active) return;
                    
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, BIRD_RADIUS, 0, Math.PI * 2);
                    ctx.fillStyle = state.players[this.playerId]?.color || '#e74c3c';
                    ctx.fill();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#333';
                    ctx.stroke();
                    
                    // Bird eye
                    ctx.beginPath();
                    ctx.arc(this.x + 5, this.y - 3, 3, 0, Math.PI * 2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(this.x + 6, this.y - 3, 1.5, 0, Math.PI * 2);
                    ctx.fillStyle = '#000';
                    ctx.fill();
                }
            }

            // Pig class
            class Pig {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.active = true;
                }
                
                draw() {
                    if (!this.active) return;
                    
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, PIG_RADIUS, 0, Math.PI * 2);
                    ctx.fillStyle = '#27ae60';
                    ctx.fill();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#1e8449';
                    ctx.stroke();
                    
                    // Pig features
                    ctx.beginPath();
                    ctx.arc(this.x - 5, this.y - 5, 3, 0, Math.PI * 2);
                    ctx.fillStyle = '#27ae60';
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(this.x + 5, this.y - 5, 3, 0, Math.PI * 2);
                    ctx.fillStyle = '#27ae60';
                    ctx.fill();
                }
            }

            // Block class
            class Block {
                constructor(x, y, width, height, type = 'wood') {
                    this.x = x;
                    this.y = y;
                    this.width = width;
                    this.height = height;
                    this.type = type;
                    this.active = true;
                    this.health = type === 'stone' ? 3 : 1;
                }
                
                draw() {
                    if (!this.active) return;
                    
                    ctx.fillStyle = this.type === 'stone' ? '#7f8c8d' : '#8B4513';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = this.type === 'stone' ? '#5d6d7e' : '#654321';
                    ctx.strokeRect(this.x, this.y, this.width, this.height);
                }
            }

            class AngryBirdsModel extends Multisynq.Model {
                init() {
                    this.players = {};
                    this.birds = [];
                    this.pigs = [];
                    this.blocks = [];
                    this.scores = {};
                    this.currentTurn = null;
                    this.gameStarted = false;
                    
                    this.subscribe(this.sessionId, "playerJoin", this.handlePlayerJoin);
                    this.subscribe(this.sessionId, "birdLaunch", this.handleBirdLaunch);
                    this.subscribe(this.sessionId, "gameState", this.handleGameState);
                    this.subscribe(this.sessionId, "turnChange", this.handleTurnChange);
                }
                
                handlePlayerJoin(data) {
                    this.players[data.id] = data;
                    this.scores[data.id] = 0;
                    
                    if (Object.keys(this.players).length >= 2 && !this.gameStarted) {
                        this.startGame();
                    }
                    
                    this.publish(this.sessionId, "gameState", {
                        players: this.players,
                        birds: this.birds,
                        pigs: this.pigs,
                        blocks: this.blocks,
                        scores: this.scores,
                        currentTurn: this.currentTurn,
                        gameStarted: this.gameStarted
                    });
                }
                
                handleBirdLaunch(data) {
                    this.birds.push(new Bird(data.x, data.y, data.playerId));
                    this.birds[this.birds.length - 1].vx = data.vx;
                    this.birds[this.birds.length - 1].vy = data.vy;
                    this.birds[this.birds.length - 1].launched = true;
                    
                    this.publish(this.sessionId, "gameState", {
                        players: this.players,
                        birds: this.birds,
                        pigs: this.pigs,
                        blocks: this.blocks,
                        scores: this.scores,
                        currentTurn: this.currentTurn,
                        gameStarted: this.gameStarted
                    });
                }
                
                handleGameState(data) {
                    this.players = data.players;
                    this.birds = data.birds;
                    this.pigs = data.pigs;
                    this.blocks = data.blocks;
                    this.scores = data.scores;
                    this.currentTurn = data.currentTurn;
                    this.gameStarted = data.gameStarted;
                    
                    window.state = {
                        players: this.players,
                        birds: this.birds,
                        pigs: this.pigs,
                        blocks: this.blocks,
                        scores: this.scores,
                        currentTurn: this.currentTurn,
                        gameStarted: this.gameStarted
                    };
                }
                
                handleTurnChange(data) {
                    this.currentTurn = data.playerId;
                    this.publish(this.sessionId, "gameState", {
                        players: this.players,
                        birds: this.birds,
                        pigs: this.pigs,
                        blocks: this.blocks,
                        scores: this.scores,
                        currentTurn: this.currentTurn,
                        gameStarted: this.gameStarted
                    });
                }
                
                startGame() {
                    this.gameStarted = true;
                    this.currentTurn = Object.keys(this.players)[0];
                    
                    // Create pigs
                    this.pigs = [
                        new Pig(700, GROUND_Y - PIG_RADIUS),
                        new Pig(750, GROUND_Y - PIG_RADIUS),
                        new Pig(800, GROUND_Y - PIG_RADIUS)
                    ];
                    
                    // Create blocks
                    this.blocks = [
                        new Block(680, GROUND_Y - 60, BLOCK_SIZE, BLOCK_SIZE),
                        new Block(680, GROUND_Y - 90, BLOCK_SIZE, BLOCK_SIZE),
                        new Block(680, GROUND_Y - 120, BLOCK_SIZE, BLOCK_SIZE),
                        new Block(730, GROUND_Y - 60, BLOCK_SIZE, BLOCK_SIZE),
                        new Block(730, GROUND_Y - 90, BLOCK_SIZE, BLOCK_SIZE),
                        new Block(780, GROUND_Y - 60, BLOCK_SIZE, BLOCK_SIZE),
                        new Block(780, GROUND_Y - 90, BLOCK_SIZE, BLOCK_SIZE)
                    ];
                    
                    this.publish(this.sessionId, "gameState", {
                        players: this.players,
                        birds: this.birds,
                        pigs: this.pigs,
                        blocks: this.blocks,
                        scores: this.scores,
                        currentTurn: this.currentTurn,
                        gameStarted: this.gameStarted
                    });
                }
            }
            
            AngryBirdsModel.register("AngryBirdsModel");
            
            class AngryBirdsView extends Multisynq.View {
                constructor(model) {
                    super(model);
                    this.model = model;
                    this.subscribe(this.sessionId, "gameState", this.updateGameState);
                }
                
                updateGameState(data) {
                    window.state = data;
                    myTurn = data.currentTurn === this.viewId;
                }
                
                sendBirdLaunch(data) {
                    this.publish(this.sessionId, "birdLaunch", data);
                }
                
                sendPlayerJoin(data) {
                    this.publish(this.sessionId, "playerJoin", data);
                }
            }

            let viewInstance = null;

            Multisynq.Session.join({
                apiKey: API_KEY,
                appId: APP_ID,
                name: ROOM_ID,
                password: PASSWORD,
                model: AngryBirdsModel,
                view: AngryBirdsView,
                debug: []
            }).then(session => {
                viewInstance = session.view;
                myId = session.view.viewId;
                
                console.log("Session joined, myId:", myId);
                
                // Send player join data
                viewInstance.sendPlayerJoin({
                    id: myId,
                    color: myColor,
                    name: `Player ${myId.slice(-4)}`
                });
                
            }).catch(e => {
                console.error("Multisynq Session Join Error:", e);
            });

            // Mouse events for slingshot
            canvas.addEventListener('mousedown', (e) => {
                if (!myTurn || !state.gameStarted) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (Math.abs(x - SLINGSHOT_X) < 30 && Math.abs(y - SLINGSHOT_Y) < 30) {
                    isDragging = true;
                    dragStart = { x, y };
                    currentBird = new Bird(SLINGSHOT_X, SLINGSHOT_Y, myId);
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging || !currentBird) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                currentBird.x = x;
                currentBird.y = y;
            });

            canvas.addEventListener('mouseup', (e) => {
                if (!isDragging || !currentBird) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const dx = SLINGSHOT_X - x;
                const dy = SLINGSHOT_Y - y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 10) {
                    const power = Math.min(distance / 3, 15);
                    const vx = (dx / distance) * power;
                    const vy = (dy / distance) * power;
                    
                    viewInstance.sendBirdLaunch({
                        x: SLINGSHOT_X,
                        y: SLINGSHOT_Y,
                        vx: vx,
                        vy: vy,
                        playerId: myId
                    });
                }
                
                isDragging = false;
                currentBird = null;
            });

            function updateView() {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw ground
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(0, GROUND_Y, canvas.width, canvas.height - GROUND_Y);
                
                // Draw slingshot
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(SLINGSHOT_X - 10, GROUND_Y);
                ctx.lineTo(SLINGSHOT_X - 10, SLINGSHOT_Y - 20);
                ctx.moveTo(SLINGSHOT_X + 10, GROUND_Y);
                ctx.lineTo(SLINGSHOT_X + 10, SLINGSHOT_Y - 20);
                ctx.stroke();
                
                // Draw slingshot pouch
                if (isDragging && currentBird) {
                    ctx.strokeStyle = '#8B4513';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(SLINGSHOT_X - 10, SLINGSHOT_Y - 20);
                    ctx.lineTo(currentBird.x - 5, currentBird.y);
                    ctx.moveTo(SLINGSHOT_X + 10, SLINGSHOT_Y - 20);
                    ctx.lineTo(currentBird.x + 5, currentBird.y);
                    ctx.stroke();
                }
                
                // Draw blocks
                state.blocks.forEach(block => block.draw());
                
                // Draw pigs
                state.pigs.forEach(pig => pig.draw());
                
                // Update and draw birds
                state.birds.forEach(bird => {
                    bird.update();
                    bird.draw();
                });
                
                // Draw current bird being dragged
                if (isDragging && currentBird) {
                    currentBird.draw();
                }
                
                // Draw turn indicator
                if (state.gameStarted) {
                    ctx.fillStyle = myTurn ? '#27ae60' : '#e74c3c';
                    ctx.font = '20px Arial';
                    ctx.fillText(myTurn ? 'Your Turn!' : 'Opponent\'s Turn', 10, 30);
                }
                
                // Draw player info
                let yOffset = 60;
                Object.keys(state.players).forEach(playerId => {
                    const player = state.players[playerId];
                    ctx.fillStyle = player.color;
                    ctx.font = '16px Arial';
                    ctx.fillText(`${player.name}: ${state.scores[playerId] || 0}`, 10, yOffset);
                    yOffset += 25;
                });
            }

            // Game loop
            function gameLoop() {
                updateView();
                requestAnimationFrame(gameLoop);
            }
            
            gameLoop();
        }
    </script>
    
</head>
<body>
    <h2>Multiplayer Angry Birds</h2>
    <div class="game-info">
        <div class="player-score">Player 1: <span id="score1">0</span></div>
        <div class="player-score">Player 2: <span id="score2">0</span></div>
    </div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <div class="info">
        Drag from slingshot to launch birds!<br>
        Destroy all pigs to win!
    </div>
</body>
</html>