<!DOCTYPE html>
<html>
<head>
  <title>OAuth2 Example</title>
</head>
<body>
  <script>
    const clientId = 'u-s4t2ud-3f31416f20f07157110f9500bfc937900a23e943867ebe93b4687c05b249bd05'; // Replace with your actual client ID
    const clientSecret = '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'; // Replace with your actual client secret
    const redirectUri = 'http://www.caginagirdemir.github.io/marketplace/market.html'; // Replace with your actual redirect URI

    // Step 2: Handle the redirect back with the authorization code
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    if (code) {
      // Step 3: Exchange authorization code for access token
      const tokenUrl = 'https://api.intra.42.fr/oauth/token'; 
      const data = {
        grant_type: 'authorization_code',
        client_id: clientId,
        client_secret: clientSecret, // Include client secret for token exchange
        code: code,
        redirect_uri: redirectUri,
      };

      fetch(tokenUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(tokenData => {
        const accessToken = tokenData.access_token;

        // Step 4: Use the access token to make an authenticated request
        fetch('https://api.intra.42.fr/v2/me', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
          },
        })
        .then(response => response.json())
        .then(userData => {
          console.log('Data received:', userData);
          document.body.innerHTML = `<pre>${JSON.stringify(userData, null, 2)}</pre>`;
        })
        .catch(error => console.error('Error fetching data:', error));
      })
      .catch(error => console.error('Error getting access token:', error));
    } else {
      // If no code is present in the URL, redirect to the authorization URL
      const authorizationUrl = `https://api.intra.42.fr/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=public`;
      window.location.href = authorizationUrl;
    }
  </script>
</body>
</html>
